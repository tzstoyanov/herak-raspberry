From c89dbb519e0784cc71aab0c11fd719c22c9889ac Mon Sep 17 00:00:00 2001
From: Tzvetomir Stoyanov <tz.stoyanov@gmail.com>
Date: Mon, 7 Apr 2025 14:48:13 +0100
Subject: [PATCH 3/5] Allow reserving an area at the end of flash for a
 filesystem

From: Melanie <melanie@t-data.com>

---
 CMakeLists.txt                      | 6 +++++-
 linker_common/linker_definitions.in | 3 ++-
 src/bootloader_app.c                | 3 +++
 src/flash_utils.h                   | 2 +-
 4 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/libs/pico_fota_bootloader/CMakeLists.txt b/libs/pico_fota_bootloader/CMakeLists.txt
index dc55e08..ff6f93c 100644
--- a/libs/pico_fota_bootloader/CMakeLists.txt
+++ b/libs/pico_fota_bootloader/CMakeLists.txt
@@ -36,13 +36,17 @@ option(PFB_WITH_IMAGE_ENCRYPTION "Enables image encryption using AES ECB algorit
 option(PFB_AES_KEY "AES key used for image encryption and decryption")
 option(PFB_WITH_SHA256_HASHING "Enables image SHA256 appending and checking" ON)
 
+if ( NOT PFB_RESERVED_FILESYSTEM_SIZE_KB )
+    set(PFB_RESERVED_FILESYSTEM_SIZE_KB 0)
+endif()
+
 ########################################
 # Build linker definitions
 ########################################
 # PICO_FLASH_SIZE_BYTES
 execute_process(
     COMMAND cat ${CMAKE_CURRENT_LIST_DIR}/linker_common/linker_definitions.in
-    COMMAND ${CMAKE_C_COMPILER} -DFLASH_SIZE=${PICO_FLASH_SIZE_BYTES} -E -P -o ${CMAKE_BINARY_DIR}/linker_definitions.ld -
+    COMMAND ${CMAKE_C_COMPILER} -DFLASH_SIZE=${PICO_FLASH_SIZE_BYTES} -DFILESYSTEM_SIZE=${PFB_RESERVED_FILESYSTEM_SIZE_KB} -E -P -o ${CMAKE_BINARY_DIR}/linker_definitions.ld -
     )
 ########################################
 # Check and set AES key
diff --git a/libs/pico_fota_bootloader/linker_common/linker_definitions.in b/libs/pico_fota_bootloader/linker_common/linker_definitions.in
index a0b1eda..8a46338 100644
--- a/libs/pico_fota_bootloader/linker_common/linker_definitions.in
+++ b/libs/pico_fota_bootloader/linker_common/linker_definitions.in
@@ -45,7 +45,8 @@
 */
 
 __FLASH_START = 0x10000000;
-__FLASH_SIZE = FLASH_SIZE;
+__FILESYSTEM_SIZE = (FILESYSTEM_SIZE * 1024);
+__FLASH_SIZE = FLASH_SIZE - __FILESYSTEM_SIZE;
 __BOOTLOADER_LENGTH = 36k;
 
 __FLASH_INFO_START = __FLASH_START + __BOOTLOADER_LENGTH;
diff --git a/libs/pico_fota_bootloader/src/bootloader_app.c b/libs/pico_fota_bootloader/src/bootloader_app.c
index f46e40e..b8a3918 100644
--- a/libs/pico_fota_bootloader/src/bootloader_app.c
+++ b/libs/pico_fota_bootloader/src/bootloader_app.c
@@ -38,6 +38,7 @@
 #include <pico/stdlib.h>
 
 #include <pico_fota_bootloader/core.h>
+#include <stdlib.h>
 
 #include "flash_utils.h"
 #include "linker_definitions.h"
@@ -149,6 +150,7 @@ static bool is_application_slot_empty(void) {
 
 static void print_welcome_message(void) {
 #ifdef PFB_WITH_BOOTLOADER_LOGS
+    uint32_t space = PFB_ADDR_AS_U32(__FLASH_SWAP_SPACE_LENGTH) / 1024;
     puts("");
     puts("***********************************************************");
     puts("*                                                         *");
@@ -157,6 +159,7 @@ static void print_welcome_message(void) {
     puts("*                                                         *");
     puts("***********************************************************");
     puts("");
+    printf("Maximum code length: %luK\r\n", space);
 #endif // PFB_WITH_BOOTLOADER_LOGS
 }
 
diff --git a/libs/pico_fota_bootloader/src/flash_utils.h b/libs/pico_fota_bootloader/src/flash_utils.h
index 1b6c423..051df7f 100644
--- a/libs/pico_fota_bootloader/src/flash_utils.h
+++ b/libs/pico_fota_bootloader/src/flash_utils.h
@@ -21,7 +21,7 @@ extern "C" {
 #define PFB_SHOULD_ROLLBACK_MAGIC 0xdeadead
 #define PFB_SHOULD_NOT_ROLLBACK_MAGIC 0x00000000
 
-#define PFB_ADDR_AS_U32(Data) (uint32_t) & (Data)
+#define PFB_ADDR_AS_U32(Data) ((uint32_t) & (Data))
 #define PFB_ADDR_WITH_XIP_OFFSET_AS_U32(Data) \
     (PFB_ADDR_AS_U32(Data) - (XIP_BASE))
 
-- 
2.51.0

